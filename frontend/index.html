<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading System Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #1e293b;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: #60a5fa;
            font-size: 28px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: #1e293b;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #334155;
        }

        .card h2 {
            color: #60a5fa;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .stat {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #334155;
        }

        .stat:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #94a3b8;
        }

        .stat-value {
            color: #e2e8f0;
            font-weight: 600;
        }

        .positive {
            color: #10b981;
        }

        .negative {
            color: #ef4444;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #334155;
        }

        th {
            color: #60a5fa;
            font-weight: 600;
        }

        tr:hover {
            background: #1e293b;
        }

        .article-item {
            padding: 15px;
            border-bottom: 1px solid #334155;
            cursor: pointer;
            transition: background 0.2s;
        }

        .article-item:hover {
            background: #334155;
        }

        .article-item:last-child {
            border-bottom: none;
        }

        .article-title {
            color: #e2e8f0;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .article-meta {
            color: #94a3b8;
            font-size: 12px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-buy {
            background: #10b981;
            color: white;
        }

        .badge-sell {
            background: #ef4444;
            color: white;
        }

        .badge-hold {
            background: #64748b;
            color: white;
        }

        .badge-pending {
            background: #f59e0b;
            color: white;
        }

        .badge-approved {
            background: #10b981;
            color: white;
        }

        .badge-rejected {
            background: #ef4444;
            color: white;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #94a3b8;
        }

        .timestamp {
            color: #64748b;
            font-size: 12px;
            margin-top: 10px;
        }

        .analysis-item {
            padding: 15px;
            border-bottom: 1px solid #334155;
            background: #0f172a;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 3px solid #60a5fa;
        }

        .analysis-item:last-child {
            border-bottom: none;
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .analysis-agent {
            color: #60a5fa;
            font-weight: 600;
            font-size: 14px;
        }

        .analysis-type {
            background: #334155;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            text-transform: uppercase;
        }

        .analysis-reasoning {
            color: #cbd5e1;
            margin: 10px 0;
            padding: 10px;
            background: #1e293b;
            border-radius: 4px;
            white-space: pre-wrap;
            font-size: 13px;
            line-height: 1.6;
        }

        .debate-item {
            padding: 20px;
            border-bottom: 1px solid #334155;
            background: #0f172a;
            margin-bottom: 15px;
            border-radius: 6px;
        }

        .debate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .debate-ticker {
            font-size: 18px;
            font-weight: 600;
            color: #60a5fa;
        }

        .debate-arguments {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }

        .argument-box {
            padding: 15px;
            border-radius: 6px;
            border: 2px solid;
        }

        .bull-argument {
            background: rgba(16, 185, 129, 0.1);
            border-color: #10b981;
        }

        .bear-argument {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
        }

        .argument-label {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .bull-argument .argument-label {
            color: #10b981;
        }

        .bear-argument .argument-label {
            color: #ef4444;
        }

        .argument-text {
            color: #cbd5e1;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .consensus {
            margin-top: 15px;
            padding: 12px;
            background: #1e293b;
            border-radius: 4px;
            border-left: 3px solid #f59e0b;
        }

        .consensus-label {
            color: #f59e0b;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .consensus-text {
            color: #cbd5e1;
            font-size: 13px;
            line-height: 1.6;
        }

        .proposal-reasoning {
            padding: 15px;
            border-bottom: 1px solid #334155;
            background: #0f172a;
            margin-bottom: 10px;
            border-radius: 6px;
        }

        .proposal-reasoning:last-child {
            border-bottom: none;
        }

        .reasoning-text {
            color: #cbd5e1;
            margin-top: 10px;
            padding: 10px;
            background: #1e293b;
            border-radius: 4px;
            white-space: pre-wrap;
            font-size: 13px;
            line-height: 1.6;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: #1e293b;
            border-radius: 8px;
            padding: 30px;
            max-width: 900px;
            width: 100%;
            margin: 20px auto;
            border: 1px solid #334155;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #334155;
        }

        .modal-title {
            color: #60a5fa;
            font-size: 24px;
            font-weight: 600;
            flex: 1;
            margin-right: 20px;
        }

        .close-btn {
            color: #94a3b8;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: #334155;
            color: #e2e8f0;
        }

        .modal-section {
            margin-bottom: 25px;
        }

        .modal-section-title {
            color: #60a5fa;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #334155;
        }

        .article-content {
            color: #cbd5e1;
            line-height: 1.8;
            white-space: pre-wrap;
            padding: 15px;
            background: #0f172a;
            border-radius: 6px;
            max-height: 400px;
            overflow-y: auto;
        }

        .article-meta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .meta-item {
            padding: 12px;
            background: #0f172a;
            border-radius: 6px;
            border-left: 3px solid #60a5fa;
        }

        .meta-label {
            color: #94a3b8;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .meta-value {
            color: #e2e8f0;
            font-weight: 600;
        }

        .related-item {
            padding: 12px;
            background: #0f172a;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid #10b981;
            cursor: pointer;
            transition: all 0.2s;
        }

        .related-item:hover {
            background: #334155;
            transform: translateX(5px);
        }

        .article-item {
            cursor: pointer;
        }

        .interest-item {
            padding: 15px;
            border-bottom: 1px solid #334155;
            background: #0f172a;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid;
            transition: all 0.2s;
        }

        .interest-item:hover {
            background: #1e293b;
            transform: translateX(5px);
        }

        .interest-item.interesting {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.05);
        }

        .interest-item.not-interesting {
            border-left-color: #64748b;
            opacity: 0.7;
        }

        .interest-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .interest-ticker {
            font-size: 18px;
            font-weight: 600;
            color: #60a5fa;
        }

        .interest-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-interesting {
            background: #10b981;
            color: white;
        }

        .badge-needs-debate {
            background: #f59e0b;
            color: white;
            margin-left: 8px;
        }

        .badge-not-interesting {
            background: #64748b;
            color: white;
        }

        .interest-reasoning {
            color: #cbd5e1;
            font-size: 14px;
            line-height: 1.6;
            margin-top: 8px;
            padding: 10px;
            background: #1e293b;
            border-radius: 4px;
        }

        .interest-stats {
            display: flex;
            gap: 15px;
            margin-top: 8px;
            font-size: 12px;
            color: #94a3b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Trading System Dashboard</h1>
            <div class="status">
                <div class="status-indicator"></div>
                <span id="status-text">Connected</span>
            </div>
        </header>

        <div class="grid">
            <div class="card">
                <h2>Account Status</h2>
                <div id="account-stats" class="loading">Loading...</div>
            </div>

            <div class="card">
                <h2>Portfolio Value</h2>
                <div id="portfolio-value" class="loading">Loading...</div>
            </div>

            <div class="card">
                <h2>Active Positions</h2>
                <div id="positions-count" class="loading">Loading...</div>
            </div>
        </div>

        <div class="grid">
            <div class="card full-width">
                <h2>Current Positions</h2>
                <div id="positions-table" class="loading">Loading...</div>
            </div>
        </div>

        <div class="grid">
            <div class="card full-width">
                <h2>Recent Trades</h2>
                <div id="trades-table" class="loading">Loading...</div>
            </div>
        </div>

        <div class="grid">
            <div class="card full-width">
                <h2>Trade Proposals</h2>
                <div id="proposals-table" class="loading">Loading...</div>
            </div>
        </div>

        <div class="grid">
            <div class="card full-width">
                <h2>üéØ Trader Interest & Analysis</h2>
                <div id="trader-interest" class="loading">Loading...</div>
            </div>
        </div>

        <div class="grid">
            <div class="card full-width">
                <h2>Recent News Articles</h2>
                <div id="articles-list" class="loading">Loading...</div>
            </div>
        </div>

        <div class="grid">
            <div class="card full-width">
                <h2>Stock Snapshots</h2>
                <div id="snapshots-table" class="loading">Loading...</div>
            </div>
        </div>

        <div class="grid">
            <div class="card full-width">
                <h2>Agent Analysis & Reasoning</h2>
                <div id="analysis-events" class="loading">Loading...</div>
            </div>
        </div>

        <div class="grid">
            <div class="card full-width">
                <h2>Bull vs Bear Debates</h2>
                <div id="debates-list" class="loading">Loading...</div>
            </div>
        </div>

        <div class="grid">
            <div class="card full-width">
                <h2>Trade Proposal Reasoning</h2>
                <div id="proposals-reasoning" class="loading">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Article Detail Modal -->
    <div id="articleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Article Details</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody" class="loading">Loading...</div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let ws = null;

        async function fetchData(endpoint) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`);
                return await response.json();
            } catch (error) {
                console.error(`Error fetching ${endpoint}:`, error);
                return null;
            }
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(value);
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        function formatNumber(num) {
            if (num === null || num === undefined) return 'N/A';
            return new Intl.NumberFormat('en-US').format(num);
        }

        async function updateAccountStatus() {
            const data = await fetchData('/api/status');
            if (!data) return;

            const statsDiv = document.getElementById('account-stats');
            if (data.account) {
                statsDiv.innerHTML = `
                    <div class="stat">
                        <span class="stat-label">Cash</span>
                        <span class="stat-value">${formatCurrency(data.account.cash)}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Buying Power</span>
                        <span class="stat-value">${formatCurrency(data.account.buying_power)}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Equity</span>
                        <span class="stat-value">${formatCurrency(data.account.equity)}</span>
                    </div>
                `;
            }

            const portfolioDiv = document.getElementById('portfolio-value');
            if (data.account) {
                portfolioDiv.innerHTML = `
                    <div class="stat">
                        <span class="stat-label">Portfolio Value</span>
                        <span class="stat-value">${formatCurrency(data.account.portfolio_value)}</span>
                    </div>
                `;
            }

            const positionsCountDiv = document.getElementById('positions-count');
            positionsCountDiv.innerHTML = `
                <div class="stat">
                    <span class="stat-label">Open Positions</span>
                    <span class="stat-value">${data.positions_count || 0}</span>
                </div>
            `;
        }

        async function updatePositions() {
            const data = await fetchData('/api/positions');
            if (!data || !data.positions) return;

            const tableDiv = document.getElementById('positions-table');
            if (data.positions.length === 0) {
                tableDiv.innerHTML = '<p style="text-align: center; color: #94a3b8;">No open positions</p>';
                return;
            }

            let html = '<table><thead><tr><th>Symbol</th><th>Quantity</th><th>Avg Entry</th><th>Current Price</th><th>Market Value</th><th>P/L</th></tr></thead><tbody>';
            data.positions.forEach(pos => {
                const pl = pos.unrealized_pl || 0;
                const plClass = pl >= 0 ? 'positive' : 'negative';
                html += `
                    <tr>
                        <td><strong>${pos.symbol}</strong></td>
                        <td>${formatNumber(pos.qty)}</td>
                        <td>${formatCurrency(pos.avg_entry_price)}</td>
                        <td>${formatCurrency(pos.current_price)}</td>
                        <td>${formatCurrency(pos.market_value)}</td>
                        <td class="${plClass}">${formatCurrency(pl)}</td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            tableDiv.innerHTML = html;
        }

        async function updateTrades() {
            const data = await fetchData('/api/trades?limit=20');
            if (!data || !data.trades) return;

            const tableDiv = document.getElementById('trades-table');
            if (data.trades.length === 0) {
                tableDiv.innerHTML = '<p style="text-align: center; color: #94a3b8;">No trades yet</p>';
                return;
            }

            let html = '<table><thead><tr><th>Time</th><th>Symbol</th><th>Action</th><th>Quantity</th><th>Price</th><th>Status</th></tr></thead><tbody>';
            data.trades.forEach(trade => {
                const actionClass = trade.action === 'BUY' ? 'badge-buy' : 'badge-sell';
                html += `
                    <tr style="cursor: pointer;" onclick="showTradeDetail(${trade.id})" title="Click to view details">
                        <td>${formatDate(trade.executed_at)}</td>
                        <td><strong>${trade.ticker}</strong></td>
                        <td><span class="badge ${actionClass}">${trade.action}</span></td>
                        <td>${formatNumber(trade.quantity)}</td>
                        <td>${formatCurrency(trade.execution_price)}</td>
                        <td><span class="badge badge-approved">${trade.status}</span></td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            tableDiv.innerHTML = html;
        }

        async function updateProposals() {
            const data = await fetchData('/api/proposals?limit=20');
            if (!data || !data.proposals) return;

            const tableDiv = document.getElementById('proposals-table');
            if (data.proposals.length === 0) {
                tableDiv.innerHTML = '<p style="text-align: center; color: #94a3b8;">No proposals</p>';
                return;
            }

            let html = '<table><thead><tr><th>Time</th><th>Symbol</th><th>Action</th><th>Quantity</th><th>Price</th><th>Confidence</th><th>Status</th></tr></thead><tbody>';
            data.proposals.forEach(prop => {
                const actionClass = prop.action === 'BUY' ? 'badge-buy' : prop.action === 'SELL' ? 'badge-sell' : 'badge-hold';
                const statusClass = prop.status === 'APPROVED' ? 'badge-approved' : prop.status === 'REJECTED' ? 'badge-rejected' : 'badge-pending';
                html += `
                    <tr style="cursor: pointer;" onclick="showProposalDetail(${prop.id})" title="Click to view details">
                        <td>${formatDate(prop.created_at)}</td>
                        <td><strong>${prop.ticker}</strong></td>
                        <td><span class="badge ${actionClass}">${prop.action}</span></td>
                        <td>${formatNumber(prop.quantity)}</td>
                        <td>${prop.proposed_price ? formatCurrency(prop.proposed_price) : 'N/A'}</td>
                        <td>${prop.confidence_score ? prop.confidence_score.toFixed(1) + '%' : 'N/A'}</td>
                        <td><span class="badge ${statusClass}">${prop.status}</span></td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            tableDiv.innerHTML = html;
        }

        async function updateArticles() {
            const data = await fetchData('/api/articles?limit=20');
            if (!data || !data.articles) return;

            const listDiv = document.getElementById('articles-list');
            if (data.articles.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #94a3b8;">No articles</p>';
                return;
            }

            let html = '';
            data.articles.forEach(article => {
                html += `
                    <div class="article-item" onclick="showArticleDetail(${article.id})">
                        <div class="article-title">${article.title || 'Untitled'}</div>
                        <div class="article-meta">
                            ${article.ticker ? `<span class="badge badge-buy">${article.ticker}</span> ` : ''}
                            ${formatDate(article.timestamp || article.created_at)}
                            ${article.is_usable ? '<span class="badge badge-approved" style="margin-left: 10px;">USABLE</span>' : ''}
                        </div>
                    </div>
                `;
            });
            listDiv.innerHTML = html;
        }

        async function showArticleDetail(articleId) {
            const modal = document.getElementById('articleModal');
            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalTitle');
            
            modal.classList.add('active');
            modalBody.innerHTML = '<div class="loading">Loading article details...</div>';
            
            try {
                const data = await fetchData(`/api/articles/${articleId}`);
                if (!data || data.error) {
                    modalBody.innerHTML = `<p style="color: #ef4444;">Error: ${data?.error || 'Failed to load article'}</p>`;
                    return;
                }
                
                const article = data.article;
                modalTitle.textContent = article.title || 'Article Details';
                
                let html = `
                    <div class="modal-section">
                        <div class="article-meta-grid">
                            <div class="meta-item">
                                <div class="meta-label">Ticker</div>
                                <div class="meta-value">${article.ticker || 'N/A'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Published</div>
                                <div class="meta-value">${formatDate(article.timestamp || article.created_at)}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Status</div>
                                <div class="meta-value">
                                    ${article.is_usable ? '<span class="badge badge-approved">USABLE</span>' : '<span class="badge badge-rejected">UNUSABLE</span>'}
                                </div>
                            </div>
                            ${article.raw_url ? `
                            <div class="meta-item">
                                <div class="meta-label">Source</div>
                                <div class="meta-value">
                                    <a href="${article.raw_url}" target="_blank" style="color: #60a5fa; text-decoration: none;">View Original</a>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="modal-section">
                        <div class="modal-section-title">Article Content</div>
                        <div class="article-content">${article.content_text || 'No content available'}</div>
                    </div>
                `;
                
                if (article.reason) {
                    html += `
                        <div class="modal-section">
                            <div class="modal-section-title">Classification Reason</div>
                            <div class="article-content">${article.reason}</div>
                        </div>
                    `;
                }
                
                if (data.related_analysis && data.related_analysis.length > 0) {
                    html += `
                        <div class="modal-section">
                            <div class="modal-section-title">Related Analysis (${data.related_analysis.length})</div>
                            ${data.related_analysis.map(event => `
                                <div class="related-item">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="color: #60a5fa; font-weight: 600;">${event.agent_name || 'Agent'}</span>
                                        <span class="timestamp">${formatDate(event.created_at)}</span>
                                    </div>
                                    <div style="color: #cbd5e1; font-size: 13px;">${(event.reasoning || '').substring(0, 200)}...</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                if (data.related_debates && data.related_debates.length > 0) {
                    html += `
                        <div class="modal-section">
                            <div class="modal-section-title">Related Debates (${data.related_debates.length})</div>
                            ${data.related_debates.map(debate => `
                                <div class="related-item">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="color: #60a5fa; font-weight: 600;">${debate.ticker} Debate</span>
                                        <span class="timestamp">${formatDate(debate.created_at)}</span>
                                    </div>
                                    <div style="color: #cbd5e1; font-size: 13px;">
                                        <strong>Consensus:</strong> ${(debate.final_consensus || 'No consensus').substring(0, 150)}...
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                if (data.related_proposals && data.related_proposals.length > 0) {
                    html += `
                        <div class="modal-section">
                            <div class="modal-section-title">Related Trade Proposals (${data.related_proposals.length})</div>
                            ${data.related_proposals.map(prop => {
                                const actionClass = prop.action === 'BUY' ? 'badge-buy' : prop.action === 'SELL' ? 'badge-sell' : 'badge-hold';
                                return `
                                    <div class="related-item">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                            <div>
                                                <span class="badge ${actionClass}">${prop.action}</span>
                                                <strong style="color: #60a5fa; margin-left: 10px;">${prop.ticker}</strong>
                                                <span style="color: #94a3b8; margin-left: 10px;">${prop.quantity} shares</span>
                                            </div>
                                            <span class="timestamp">${formatDate(prop.created_at)}</span>
                                        </div>
                                        <div style="color: #cbd5e1; font-size: 13px;">${(prop.reasoning || '').substring(0, 200)}...</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }
                
                modalBody.innerHTML = html;
            } catch (error) {
                console.error('Error loading article:', error);
                modalBody.innerHTML = `<p style="color: #ef4444;">Error loading article: ${error.message}</p>`;
            }
        }

        async function showProposalDetail(proposalId) {
            const modal = document.getElementById('articleModal');
            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalTitle');
            
            modal.classList.add('active');
            modalBody.innerHTML = '<div class="loading">Loading proposal details...</div>';
            
            try {
                const proposals = await fetchData('/api/proposals?limit=100');
                const proposal = proposals?.proposals?.find(p => p.id === proposalId);
                
                if (!proposal) {
                    modalBody.innerHTML = `<p style="color: #ef4444;">Proposal not found</p>`;
                    return;
                }
                
                const actionClass = proposal.action === 'BUY' ? 'badge-buy' : proposal.action === 'SELL' ? 'badge-sell' : 'badge-hold';
                const statusClass = proposal.status === 'APPROVED' ? 'badge-approved' : proposal.status === 'REJECTED' ? 'badge-rejected' : 'badge-pending';
                
                modalTitle.textContent = `${proposal.action} ${proposal.ticker} - Trade Proposal`;
                
                let html = `
                    <div class="modal-section">
                        <div class="article-meta-grid">
                            <div class="meta-item">
                                <div class="meta-label">Ticker</div>
                                <div class="meta-value">${proposal.ticker || 'N/A'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Action</div>
                                <div class="meta-value"><span class="badge ${actionClass}">${proposal.action}</span></div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Quantity</div>
                                <div class="meta-value">${formatNumber(proposal.quantity)}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Proposed Price</div>
                                <div class="meta-value">${proposal.proposed_price ? formatCurrency(proposal.proposed_price) : 'Market'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Confidence</div>
                                <div class="meta-value">${proposal.confidence_score ? proposal.confidence_score.toFixed(1) + '%' : 'N/A'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Status</div>
                                <div class="meta-value"><span class="badge ${statusClass}">${proposal.status}</span></div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Created</div>
                                <div class="meta-value">${formatDate(proposal.created_at)}</div>
                            </div>
                            ${proposal.updated_at ? `
                            <div class="meta-item">
                                <div class="meta-label">Updated</div>
                                <div class="meta-value">${formatDate(proposal.updated_at)}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="modal-section">
                        <div class="modal-section-title">Reasoning</div>
                        <div class="article-content">${proposal.reasoning || 'No reasoning provided'}</div>
                    </div>
                `;
                
                modalBody.innerHTML = html;
            } catch (error) {
                console.error('Error loading proposal:', error);
                modalBody.innerHTML = `<p style="color: #ef4444;">Error loading proposal: ${error.message}</p>`;
            }
        }

        async function showTradeDetail(tradeId) {
            const modal = document.getElementById('articleModal');
            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalTitle');
            
            modal.classList.add('active');
            modalBody.innerHTML = '<div class="loading">Loading trade details...</div>';
            
            try {
                const trades = await fetchData('/api/trades?limit=100');
                const trade = trades?.trades?.find(t => t.id === tradeId);
                
                if (!trade) {
                    modalBody.innerHTML = `<p style="color: #ef4444;">Trade not found</p>`;
                    return;
                }
                
                const actionClass = trade.action === 'BUY' ? 'badge-buy' : 'badge-sell';
                
                modalTitle.textContent = `${trade.action} ${trade.ticker} - Executed Trade`;
                
                let html = `
                    <div class="modal-section">
                        <div class="article-meta-grid">
                            <div class="meta-item">
                                <div class="meta-label">Ticker</div>
                                <div class="meta-value">${trade.ticker || 'N/A'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Action</div>
                                <div class="meta-value"><span class="badge ${actionClass}">${trade.action}</span></div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Quantity</div>
                                <div class="meta-value">${formatNumber(trade.quantity)}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Execution Price</div>
                                <div class="meta-value">${formatCurrency(trade.execution_price)}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Status</div>
                                <div class="meta-value"><span class="badge badge-approved">${trade.status}</span></div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Executed At</div>
                                <div class="meta-value">${formatDate(trade.executed_at)}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                if (trade.proposal_id) {
                    html += `
                        <div class="modal-section">
                            <div class="modal-section-title">Related Proposal</div>
                            <div class="article-content">This trade was executed from proposal ID: ${trade.proposal_id}</div>
                        </div>
                    `;
                }
                
                modalBody.innerHTML = html;
            } catch (error) {
                console.error('Error loading trade:', error);
                modalBody.innerHTML = `<p style="color: #ef4444;">Error loading trade: ${error.message}</p>`;
            }
        }

        async function showDebateDetail(debateId) {
            const modal = document.getElementById('articleModal');
            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalTitle');
            
            modal.classList.add('active');
            modalBody.innerHTML = '<div class="loading">Loading debate details...</div>';
            
            try {
                const debates = await fetchData('/api/debates?limit=100');
                const debate = debates?.debates?.find(d => d.id === debateId);
                
                if (!debate) {
                    modalBody.innerHTML = `<p style="color: #ef4444;">Debate not found</p>`;
                    return;
                }
                
                const bullArg = debate.bull_argument || 'No bull argument';
                const bearArg = debate.bear_argument || 'No bear argument';
                const consensus = debate.final_consensus || 'No consensus reached';
                
                let transcript = '';
                if (debate.transcript) {
                    try {
                        const transcriptData = typeof debate.transcript === 'string' 
                            ? JSON.parse(debate.transcript) 
                            : debate.transcript;
                        if (Array.isArray(transcriptData)) {
                            transcript = transcriptData.map(msg => 
                                `${msg.role || 'unknown'}: ${msg.content || ''}`
                            ).join('\n\n');
                        } else if (typeof transcriptData === 'string') {
                            transcript = transcriptData;
                        }
                    } catch (e) {
                        transcript = String(debate.transcript);
                    }
                }
                
                modalTitle.textContent = `${debate.ticker || 'Stock'} Debate`;
                
                let html = `
                    <div class="modal-section">
                        <div class="article-meta-grid">
                            <div class="meta-item">
                                <div class="meta-label">Ticker</div>
                                <div class="meta-value">${debate.ticker || 'N/A'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Type</div>
                                <div class="meta-value">${debate.debate_type || 'DEBATE'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Created</div>
                                <div class="meta-value">${formatDate(debate.created_at)}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-section">
                        <div class="modal-section-title">üêÇ Bull Argument</div>
                        <div class="article-content">${bullArg}</div>
                    </div>
                    
                    <div class="modal-section">
                        <div class="modal-section-title">üêª Bear Argument</div>
                        <div class="article-content">${bearArg}</div>
                    </div>
                    
                    ${transcript ? `
                    <div class="modal-section">
                        <div class="modal-section-title">Debate Transcript</div>
                        <div class="article-content">${transcript}</div>
                    </div>
                    ` : ''}
                    
                    <div class="modal-section">
                        <div class="modal-section-title">üìä Final Consensus</div>
                        <div class="article-content">${consensus}</div>
                    </div>
                `;
                
                modalBody.innerHTML = html;
            } catch (error) {
                console.error('Error loading debate:', error);
                modalBody.innerHTML = `<p style="color: #ef4444;">Error loading debate: ${error.message}</p>`;
            }
        }

        function closeModal() {
            const modal = document.getElementById('articleModal');
            modal.classList.remove('active');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('articleModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Close modal with ESC key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function updateSnapshots() {
            const data = await fetchData('/api/snapshots');
            if (!data || !data.snapshots) return;

            const tableDiv = document.getElementById('snapshots-table');
            if (data.snapshots.length === 0) {
                tableDiv.innerHTML = '<p style="text-align: center; color: #94a3b8;">No snapshots</p>';
                return;
            }

            let html = '<table><thead><tr><th>Symbol</th><th>Price</th><th>High</th><th>Low</th><th>Volume</th><th>Time</th></tr></thead><tbody>';
            data.snapshots.forEach(snap => {
                html += `
                    <tr>
                        <td><strong>${snap.ticker}</strong></td>
                        <td>${formatCurrency(snap.price)}</td>
                        <td>${snap.high ? formatCurrency(snap.high) : 'N/A'}</td>
                        <td>${snap.low ? formatCurrency(snap.low) : 'N/A'}</td>
                        <td>${formatNumber(snap.volume)}</td>
                        <td>${formatDate(snap.snapshot_time)}</td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            tableDiv.innerHTML = html;
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                document.getElementById('status-text').textContent = 'Connected';
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'update') {
                    updateAccountStatus();
                    updatePositions();
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                document.getElementById('status-text').textContent = 'Connection Error';
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                document.getElementById('status-text').textContent = 'Disconnected';
                setTimeout(connectWebSocket, 5000);
            };
        }

        async function updateAnalysis() {
            const data = await fetchData('/api/analysis?limit=20');
            if (!data || !data.events) return;

            const div = document.getElementById('analysis-events');
            if (data.events.length === 0) {
                div.innerHTML = '<p style="text-align: center; color: #94a3b8;">No analysis events yet</p>';
                return;
            }

            let html = '';
            data.events.forEach(event => {
                const reasoning = event.reasoning || 'No reasoning provided';
                html += `
                    <div class="analysis-item">
                        <div class="analysis-header">
                            <div>
                                <span class="analysis-agent">${event.agent_name || 'Unknown Agent'}</span>
                                <span class="badge badge-buy" style="margin-left: 10px;">${event.ticker || 'N/A'}</span>
                            </div>
                            <div>
                                <span class="analysis-type">${event.event_type || 'ANALYSIS'}</span>
                                <span class="timestamp" style="margin-left: 10px;">${formatDate(event.created_at)}</span>
                            </div>
                        </div>
                        <div class="analysis-reasoning">${reasoning}</div>
                    </div>
                `;
            });
            div.innerHTML = html;
        }

        async function updateDebates() {
            const data = await fetchData('/api/debates?limit=10');
            if (!data || !data.debates) return;

            const div = document.getElementById('debates-list');
            if (data.debates.length === 0) {
                div.innerHTML = '<p style="text-align: center; color: #94a3b8;">No debates yet</p>';
                return;
            }

            let html = '';
            data.debates.forEach(debate => {
                const bullArg = debate.bull_argument || 'No bull argument';
                const bearArg = debate.bear_argument || 'No bear argument';
                const consensus = debate.final_consensus || 'No consensus reached';
                
                let transcript = '';
                if (debate.transcript) {
                    try {
                        const transcriptData = typeof debate.transcript === 'string' 
                            ? JSON.parse(debate.transcript) 
                            : debate.transcript;
                        if (Array.isArray(transcriptData)) {
                            transcript = transcriptData.map(msg => 
                                `${msg.role || 'unknown'}: ${msg.content || ''}`
                            ).join('\n\n');
                        } else if (typeof transcriptData === 'string') {
                            transcript = transcriptData;
                        }
                    } catch (e) {
                        transcript = String(debate.transcript);
                    }
                }

                html += `
                    <div class="debate-item" style="cursor: pointer;" onclick="showDebateDetail(${debate.id})" title="Click to view full details">
                        <div class="debate-header">
                            <div class="debate-ticker">${debate.ticker || 'N/A'}</div>
                            <div>
                                <span class="badge badge-pending">${debate.debate_type || 'DEBATE'}</span>
                                <span class="timestamp" style="margin-left: 10px;">${formatDate(debate.created_at)}</span>
                            </div>
                        </div>
                        <div class="debate-arguments">
                            <div class="argument-box bull-argument">
                                <div class="argument-label">üêÇ BULL ARGUMENT</div>
                                <div class="argument-text">${bullArg.substring(0, 300)}${bullArg.length > 300 ? '...' : ''}</div>
                            </div>
                            <div class="argument-box bear-argument">
                                <div class="argument-label">üêª BEAR ARGUMENT</div>
                                <div class="argument-text">${bearArg.substring(0, 300)}${bearArg.length > 300 ? '...' : ''}</div>
                            </div>
                        </div>
                        <div class="consensus">
                            <div class="consensus-label">üìä FINAL CONSENSUS</div>
                            <div class="consensus-text">${consensus.substring(0, 200)}${consensus.length > 200 ? '...' : ''}</div>
                        </div>
                    </div>
                `;
            });
            div.innerHTML = html;
        }

        async function updateProposalsReasoning() {
            const data = await fetchData('/api/proposals?limit=20');
            if (!data || !data.proposals) return;

            const div = document.getElementById('proposals-reasoning');
            if (data.proposals.length === 0) {
                div.innerHTML = '<p style="text-align: center; color: #94a3b8;">No proposals yet</p>';
                return;
            }

            let html = '';
            data.proposals.forEach(prop => {
                const actionClass = prop.action === 'BUY' ? 'badge-buy' : prop.action === 'SELL' ? 'badge-sell' : 'badge-hold';
                const statusClass = prop.status === 'APPROVED' ? 'badge-approved' : prop.status === 'REJECTED' ? 'badge-rejected' : 'badge-pending';
                const reasoning = prop.reasoning || 'No reasoning provided';
                
                html += `
                    <div class="proposal-reasoning">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <span class="badge ${actionClass}" style="margin-right: 10px;">${prop.action}</span>
                                <strong style="color: #60a5fa; font-size: 16px;">${prop.ticker}</strong>
                                <span style="margin-left: 10px; color: #94a3b8;">
                                    ${prop.quantity} shares @ ${prop.proposed_price ? formatCurrency(prop.proposed_price) : 'market'}
                                </span>
                            </div>
                            <div>
                                <span class="badge ${statusClass}">${prop.status}</span>
                                ${prop.confidence_score ? `<span style="margin-left: 10px; color: #f59e0b;">Confidence: ${prop.confidence_score.toFixed(1)}%</span>` : ''}
                                <span class="timestamp" style="margin-left: 10px;">${formatDate(prop.created_at)}</span>
                            </div>
                        </div>
                        <div class="reasoning-text">${reasoning}</div>
                    </div>
                `;
            });
            div.innerHTML = html;
        }

        async function updateTraderInterest() {
            const data = await fetchData('/api/trader-interest?limit=20');
            if (!data) return;

            const div = document.getElementById('trader-interest');
            
            if (!data.interesting || data.interesting.length === 0) {
                div.innerHTML = `
                    <p style="text-align: center; color: #94a3b8; padding: 20px;">
                        No interesting tickers analyzed yet. The trader will analyze tickers every trading cycle.
                    </p>
                    ${data.not_interesting && data.not_interesting.length > 0 ? `
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #334155;">
                            <h3 style="color: #94a3b8; font-size: 14px; margin-bottom: 10px;">Recently Analyzed (Not Interesting)</h3>
                            ${data.not_interesting.slice(0, 5).map(item => `
                                <div class="interest-item not-interesting">
                                    <div class="interest-header">
                                        <div class="interest-ticker">${item.ticker || 'N/A'}</div>
                                        <div>
                                            <span class="badge badge-not-interesting">Not Interesting</span>
                                            <span class="timestamp" style="margin-left: 10px;">${formatDate(item.created_at)}</span>
                                        </div>
                                    </div>
                                    ${item.reasoning ? `
                                        <div class="interest-reasoning">${item.reasoning.substring(0, 200)}${item.reasoning.length > 200 ? '...' : ''}</div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;
                return;
            }

            let html = `
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border-left: 4px solid #10b981;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: #10b981; font-size: 16px;">${data.interesting.length} Interesting Ticker${data.interesting.length !== 1 ? 's' : ''}</strong>
                            <span style="color: #94a3b8; margin-left: 10px; font-size: 13px;">out of ${data.total_analyzed || 0} analyzed</span>
                        </div>
                    </div>
                </div>
            `;

            data.interesting.forEach(item => {
                const needsDebate = item.needs_debate === 'true' || item.needs_debate === true;
                const confidence = item.confidence ? parseFloat(item.confidence) : null;
                const reasoning = item.reasoning || item.full_reasoning || 'No reasoning provided';
                
                html += `
                    <div class="interest-item interesting">
                        <div class="interest-header">
                            <div>
                                <span class="interest-ticker">${item.ticker || 'N/A'}</span>
                                <span class="badge badge-interesting">Interesting</span>
                                ${needsDebate ? '<span class="badge badge-needs-debate">Needs Debate</span>' : ''}
                                ${confidence !== null ? `<span style="margin-left: 8px; color: #f59e0b; font-size: 12px;">Confidence: ${confidence.toFixed(0)}%</span>` : ''}
                            </div>
                            <div>
                                <span class="timestamp">${formatDate(item.created_at)}</span>
                            </div>
                        </div>
                        <div class="interest-reasoning">${reasoning}</div>
                        <div class="interest-stats">
                            <span>Analysis ID: ${item.id}</span>
                            ${needsDebate ? '<span>‚Ä¢ Will trigger debate</span>' : '<span>‚Ä¢ Direct proposal</span>'}
                        </div>
                    </div>
                `;
            });

            if (data.not_interesting && data.not_interesting.length > 0) {
                html += `
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #334155;">
                        <h3 style="color: #94a3b8; font-size: 14px; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px;">
                            Recently Analyzed (Not Interesting) - ${data.not_interesting.length} tickers
                        </h3>
                        ${data.not_interesting.slice(0, 5).map(item => `
                            <div class="interest-item not-interesting">
                                <div class="interest-header">
                                    <div class="interest-ticker" style="font-size: 14px;">${item.ticker || 'N/A'}</div>
                                    <div>
                                        <span class="badge badge-not-interesting">Not Interesting</span>
                                        <span class="timestamp" style="margin-left: 10px;">${formatDate(item.created_at)}</span>
                                    </div>
                                </div>
                                ${item.reasoning ? `
                                    <div class="interest-reasoning" style="font-size: 12px;">${item.reasoning.substring(0, 150)}${item.reasoning.length > 150 ? '...' : ''}</div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            div.innerHTML = html;
        }

        async function updateAll() {
            await Promise.all([
                updateAccountStatus(),
                updatePositions(),
                updateTrades(),
                updateProposals(),
                updateTraderInterest(),
                updateArticles(),
                updateSnapshots(),
                updateAnalysis(),
                updateDebates(),
                updateProposalsReasoning()
            ]);
        }

        // Initial load
        updateAll();
        connectWebSocket();

        // Refresh every 10 seconds
        setInterval(updateAll, 10000);
    </script>
</body>
</html>

